"use strict";var C=Object.defineProperty,G=Object.defineProperties,v=Object.getOwnPropertyDescriptor,D=Object.getOwnPropertyDescriptors,S=Object.getOwnPropertyNames,R=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable;var U=(o,e,t)=>e in o?C(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,a=(o,e)=>{for(var t in e||(e={}))O.call(e,t)&&U(o,t,e[t]);if(R)for(var t of R(e))E.call(e,t)&&U(o,t,e[t]);return o},d=(o,e)=>G(o,D(e));var q=(o,e)=>{var t={};for(var r in o)O.call(o,r)&&e.indexOf(r)<0&&(t[r]=o[r]);if(o!=null&&R)for(var r of R(o))e.indexOf(r)<0&&E.call(o,r)&&(t[r]=o[r]);return t};var L=(o,e)=>{for(var t in e)C(o,t,{get:e[t],enumerable:!0})},W=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of S(e))!O.call(o,n)&&n!==t&&C(o,n,{get:()=>e[n],enumerable:!(r=v(e,n))||r.enumerable});return o};var $=o=>W(C({},"__esModule",{value:!0}),o);var K={};L(K,{BrowserClient:()=>w,createFrontendClient:()=>H});module.exports=$(K);var _="1.6.9";var j=["token","password","secret","apiKey","authorization","auth","key","access_token"];function I(o,e=new WeakSet){if(o==null)return o;if(typeof o=="object"){if(e.has(o))return"[CIRCULAR]";if(e.add(o),Array.isArray(o))return o.map(r=>I(r,e));let t={};for(let[r,n]of Object.entries(o)){let s=j.some(i=>r.toLowerCase().includes(i.toLowerCase()));t[r]=s?"[REDACTED]":I(n,e)}return t}return o}function h(...o){if(typeof process!="undefined"&&typeof process.env!="undefined"&&process.env.PD_SDK_DEBUG==="true"){let e=o.map(t=>I(t));console.log("[PD_SDK_DEBUG]",...e)}}var b=class{constructor(e){this.version=_;var n;this.environment=(n=e.environment)!=null?n:"production";let{apiHost:t="api.pipedream.com",workflowDomain:r="m.pipedream.net"}=e;this.apiHost=t,this.baseApiUrl=`https://${t}/v1`,this.workflowDomain=r}getEnvironment(){return this.environment}async makeRequest(e,t={}){let A=t,{params:r,headers:n,body:s,method:i="GET",baseURL:p=this.baseApiUrl}=A,f=q(A,["params","headers","body","method","baseURL"]),u=new URL(`${p}${e}`);if(r)for(let[k,T]of Object.entries(r))T!=null&&u.searchParams.append(k,String(T));let g=d(a({},n),{"X-PD-SDK-Version":_,"X-PD-Environment":this.environment}),c=null;s&&(s instanceof FormData||s instanceof URLSearchParams||typeof s=="string"?c=s:(c=JSON.stringify(s),g["Content-Type"]=g["Content-Type"]||"application/json"));let l=a({method:i,headers:g},f);["POST","PUT","PATCH"].includes(i.toUpperCase())&&c&&(l.body=c);let m=await fetch(u.toString(),l),y=await m.text();if(h("status: ",m.status),h("url: ",u.toString()),h("requestOptions: ",l),h("rawBody: ",y),!m.ok)throw new Error(`HTTP error! status: ${m.status}, body: ${y}`);let P=m.headers.get("Content-Type");if(P&&P.includes("application/json"))try{return JSON.parse(y)}catch(k){h("Couldn't parse json, falling back to raw",k)}return y}async makeAuthorizedRequest(e,t={}){let r=d(a({"Content-Type":"application/json"},t.headers),{Authorization:await this.authHeaders()});return this.makeRequest(e,d(a({},t),{headers:r}))}makeConnectRequest(e,t={}){let r="/connect";return this.projectId&&(r+=`/${this.projectId}`),r+=e,this.makeAuthorizedRequest(r,t)}getAccounts(e={}){return this.makeConnectRequest("/accounts",{method:"GET",params:e})}getApps(e){let t={};return e!=null&&e.q&&(t.q=e.q),(e==null?void 0:e.hasActions)!=null&&(t.has_actions=e.hasActions?"1":"0"),(e==null?void 0:e.hasComponents)!=null&&(t.has_components=e.hasComponents?"1":"0"),(e==null?void 0:e.hasTriggers)!=null&&(t.has_triggers=e.hasTriggers?"1":"0"),this.addRelationOpts(t,e),this.makeAuthorizedRequest("/apps",{method:"GET",params:t})}apps(e){return this.getApps(e)}getApp(e){let t=`/apps/${e}`;return this.makeAuthorizedRequest(t,{method:"GET"})}app(e){return this.getApp(e)}getComponents(e){let t={};e!=null&&e.app&&(t.app=e.app),e!=null&&e.q&&(t.q=e.q),this.addRelationOpts(t,e,20);let r="/components";return(e==null?void 0:e.componentType)==="trigger"?r="/triggers":(e==null?void 0:e.componentType)==="action"&&(r="/actions"),this.makeConnectRequest(r,{method:"GET",params:t})}components(e){return this.getComponents(e)}getComponent(e){let{key:t}=e,r=`/components/${t}`;return this.makeConnectRequest(r,{method:"GET"})}component({key:e}){return this.getComponent({key:e})}configureComponent(e){let{userId:t,externalUserId:r=t,componentId:n}=e,s=typeof n=="object"?n.key:n,i={external_user_id:r,id:s,prop_name:e.propName,configured_props:e.configuredProps,dynamic_props_id:e.dynamicPropsId,page:e.page,prev_context:e.prevContext,query:e.query};return this.makeConnectRequest("/components/configure",{method:"POST",body:i})}componentConfigure(e){return this.configureComponent(e)}reloadComponentProps(e){let{userId:t,externalUserId:r=t,componentId:n}=e,s=typeof n=="object"?n.key:n,i={external_user_id:r,id:s,configured_props:e.configuredProps,dynamic_props_id:e.dynamicPropsId};return this.makeConnectRequest("/components/props",{method:"POST",body:i})}componentReloadProps(e){return this.reloadComponentProps(e)}runAction(e){let{userId:t,externalUserId:r=t,actionId:n}=e,s=typeof n=="object"?n.key:n,i={external_user_id:r,id:s,configured_props:e.configuredProps,dynamic_props_id:e.dynamicPropsId,stash_id:e.stashId};return this.makeConnectRequest("/actions/run",{method:"POST",body:i})}actionRun(e){return this.runAction(e)}deployTrigger(e){let{userId:t,externalUserId:r=t,triggerId:n}=e,s=typeof n=="object"?n.key:n,i={external_user_id:r,id:s,configured_props:e.configuredProps,dynamic_props_id:e.dynamicPropsId,workflow_id:e.workflowId,webhook_url:e.webhookUrl};return this.makeConnectRequest("/triggers/deploy",{method:"POST",body:i})}triggerDeploy(e){return this.deployTrigger(e)}deleteTrigger(e){let{id:t,externalUserId:r,ignoreHookErrors:n=null}=e;return this.makeConnectRequest(`/deployed-triggers/${t}`,{method:"DELETE",params:{external_user_id:r,ignore_hook_errors:n}})}getTrigger(e){let{id:t,externalUserId:r}=e;return this.makeConnectRequest(`/deployed-triggers/${t}`,{method:"GET",params:{external_user_id:r}})}getTriggers(e){let{externalUserId:t}=e;return this.makeConnectRequest("/deployed-triggers",{method:"GET",params:{external_user_id:t}})}updateTrigger(e){let{id:t,externalUserId:r,active:n=null,configuredProps:s=null,name:i=null}=e;return this.makeConnectRequest(`/deployed-triggers/${t}`,{method:"PUT",params:{external_user_id:r},body:{active:n,configured_props:s,name:i}})}getTriggerEvents(e){let{id:t,externalUserId:r,limit:n=null}=e;return this.makeConnectRequest(`/deployed-triggers/${t}/events`,{method:"GET",params:{external_user_id:r,n}})}getTriggerWorkflows(e){let{id:t,externalUserId:r}=e;return this.makeConnectRequest(`/deployed-triggers/${t}/pipelines`,{method:"GET",params:{external_user_id:r}})}updateTriggerWorkflows(e){let{id:t,externalUserId:r,workflowIds:n}=e;if(!Array.isArray(n))throw new Error("workflowIds must be an array");return this.makeConnectRequest(`/deployed-triggers/${t}/pipelines`,{method:"PUT",params:{external_user_id:r},body:{workflow_ids:n}})}getTriggerWebhooks(e){let{id:t,externalUserId:r}=e;return this.makeConnectRequest(`/deployed-triggers/${t}/webhooks`,{method:"GET",params:{external_user_id:r}})}updateTriggerWebhooks(e){let{id:t,externalUserId:r,webhookUrls:n}=e;if(!Array.isArray(n))throw new Error("webhookUrls must be an array");return this.makeConnectRequest(`/deployed-triggers/${t}/webhooks`,{method:"PUT",params:{external_user_id:r},body:{webhook_urls:n}})}buildWorkflowUrl(e){let t=e.trim().replace(/[^\w-./:]/g,"").toLowerCase();if(!t)throw new Error("URL or endpoint ID is required");let r;if(t.includes(".")||t.startsWith("http")){let s;try{let i=t.startsWith("http")?t:`https://${t}`;s=new URL(i)}catch(i){throw new Error(`
          The provided URL is malformed: "${t}".
          Please provide a valid URL.
        `)}if(!s.hostname.endsWith(this.workflowDomain))throw new Error(`Invalid workflow domain. URL must end with ${this.workflowDomain}`);r=s.href}else{if(!/^e(n|o)[a-z0-9-]+$/i.test(t))throw new Error(`
          Invalid endpoint ID format.
          Must contain only letters, numbers, and hyphens, and start with either "en" or "eo".
        `);r=`https://${t}.${this.workflowDomain}`}return r}async invokeWorkflow(e,t={},r="none"){let{body:n,headers:s={}}=t,i=this.buildWorkflowUrl(e),p;switch(r){case"static_bearer_token":p=s.Authorization;break;case"oauth":p=await this.authHeaders();break;default:break}return this.makeRequest("",d(a({},t),{baseURL:i,method:t.method||"POST",headers:p?d(a({},s),{Authorization:p}):s,body:n}))}async invokeWorkflowForExternalUser(e,t,r={}){if(!(t!=null&&t.trim()))throw new Error("External user ID is required");if(!e.trim())throw new Error("Workflow URL is required");if(!await this.authHeaders())throw new Error("OAuth or token is required for invoking workflows for external users. Please pass credentials for a valid OAuth client");let{headers:n={}}=r;return this.invokeWorkflow(e,d(a({},r),{headers:d(a({},n),{"X-PD-External-User-ID":t})}),"oauth")}addRelationOpts(e,t,r){(t==null?void 0:t.limit)!=null&&(e.limit=""+t.limit),r!=null&&!e.limit&&(e.limit=""+r),t!=null&&t.after&&(e.after=t.after),t!=null&&t.before&&(e.before=t.before)}};var x=class extends Error{};function H(o={}){return new w(o)}var w=class extends b{constructor(t){super(t);this.iframeId=0;this.baseURL=`https://${t.frontendHost||"pipedream.com"}`,this.iframeURL=`${this.baseURL}/_static/connect.html`,this.tokenCallback=t.tokenCallback,this.externalUserId=t.externalUserId}async token(){if(this._token&&this._tokenExpiresAt&&this._tokenExpiresAt>new Date)return this._token;if(this._tokenRequest)return this._tokenRequest;let t=this.tokenCallback,r=this.externalUserId;if(!t)throw new Error("No token callback provided");if(!r)throw new Error("No external user ID provided");return this._tokenRequest=(async()=>{let{token:n,expires_at:s}=await t({externalUserId:r});return this._token=n,this._tokenExpiresAt=new Date(s),this._tokenRequest=void 0,n})(),this._tokenRequest}refreshToken(){this._token=void 0}rawToken(){return this._token}async connectAccount(t){var i;let r=!1,n=!1,s=p=>{var f,u,g,c,l;switch((f=p.data)==null?void 0:f.type){case"success":r=!0,n=!0,(g=t.onSuccess)==null||g.call(t,{id:(u=p.data)==null?void 0:u.authProvisionId});break;case"error":n=!0,(c=t.onError)==null||c.call(t,new x(p.data.error));break;case"close":this.cleanup(s),(l=t.onClose)==null||l.call(t,{successful:r,completed:n});break;default:break}};window.addEventListener("message",s);try{await this.createIframe(t)}catch(p){(i=t.onError)==null||i.call(t,p)}this.refreshToken()}cleanup(t){var r;(r=this.iframe)==null||r.remove(),window.removeEventListener("message",t)}async createIframe(t){let r=t.token||await this.token(),n=new URLSearchParams({token:r});if(typeof t.app=="string")n.set("app",t.app);else throw new x("Object app not yet supported");t.oauthAppId&&n.set("oauthAppId",t.oauthAppId);let s=document.createElement("iframe");s.id=`pipedream-connect-iframe-${this.iframeId++}`,s.title="Pipedream Connect",s.src=`${this.iframeURL}?${n.toString()}`,s.style.cssText="position:fixed;inset:0;z-index:2147483647;border:0;display:block;overflow:hidden auto",s.width="100%",s.height="100%",s.onload=()=>{this.iframe=s},document.body.appendChild(s)}async authHeaders(){if(!await this.token())throw new Error("No token provided");return`Bearer ${await this.token()}`}getAccounts(t){return super.getAccounts(t)}};0&&(module.exports={BrowserClient,createFrontendClient});
//# sourceMappingURL=browser.cjs.map